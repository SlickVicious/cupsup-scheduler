<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Font Loading & Styles -->
  <?!= HtmlService.createHtmlOutputFromFile('scheduler-dark-theme').getContent(); ?>
  <style>
    body {
      background-color: #36454F !important;
    }
    .event-card {
      background-color: #808080 !important;
      color: #FFFFFF !important;
    }
    .event-card h2, .event-card p, .event-card span, .event-card label, .event-card div {
      color: #FFFFFF !important;
    }
    .location-link {
      color: #FFFFFF !important; /* A bright color from the theme */
      text-decoration: none;
      font-weight: bold;
    }
    .location-link:hover {
      text-decoration: underline;
    }
    .event-time {
      color: #FFFFFF !important; /* Brighter time */
    }
    .event-date-badge {
      background-color: #6c757d !important;
      color: #FFFFFF !important;
    }
    .notes-label {
      color: #FFFFFF !important;
    }
    .time-slot-label {
      color: #FFFFFF !important;
    }
  </style>
</head>
<body>
  <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; font-family: var(--font-body); display: none;">
    <p id="loading-message">Loading...</p>
  </div>

  <div class="page-container">
    <header>
      <h1 class="title">CupSup Scheduler</h1>
      <p class="subtitle">Weekly staff scheduling and assignments.</p>
    </header>

    <div style="padding: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <input type="date" id="date-picker" class="date-picker">
        <div style="display: flex; gap: 1rem;">
          <button id="fetch-button" class="btn-fetch-week">Fetch Week Data</button>
          <button id="copy-schedule-button" class="btn-copy-schedule" style="display: none;">Copy Group Chat</button>
        </div>
      </div>

      <div id="info-section" class="info-section" style="margin-bottom: 2rem;">
        <p class="info-text">Select a date and fetch the corresponding week's events from the calendar.</p>
      </div>

      <div id="events-container" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- Event cards will be dynamically inserted here -->
      </div>
      
      <div id="schedule-preview-container" style="margin-top: 2rem; display: none;">
          <h3 style="font-family: var(--font-heading); color: var(--text-heading);">Group Chat Preview</h3>
          <textarea id="schedule-preview" class="notes-textarea" rows="15" readonly style="width: 100%; font-family: var(--font-mono);"></textarea>
      </div>

      <div id="save-container" class="save-container" style="display: none;">
        <button id="save-button" class="btn-save-assignments">Save All Assignments</button>
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE ---
      let employees = [];
      let weekStartIso = '';
      let eventsData = [];

      // --- DOM ELEMENTS ---
      const datePicker = document.getElementById('date-picker');
      const fetchButton = document.getElementById('fetch-button');
      const eventsContainer = document.getElementById('events-container');
      const saveButton = document.getElementById('save-button');
      const saveContainer = document.getElementById('save-container');
      const infoSection = document.getElementById('info-section');
      const copyScheduleButton = document.getElementById('copy-schedule-button');
      const schedulePreviewContainer = document.getElementById('schedule-preview-container');
      const schedulePreview = document.getElementById('schedule-preview');

      // --- INITIALIZATION ---
      function initialize() {
        setInitialDate();
        addEventListeners();
        showLoading('Initializing and fetching employees...');
        google.script.run
          .withSuccessHandler(onBootstrapSuccess)
          .withFailureHandler(onFailure)
          .api_getBootstrap();
      }

      function setInitialDate() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // Sunday = 0, Monday = 1
        const daysToMonday = (dayOfWeek === 0) ? -6 : 1 - dayOfWeek;
        const monday = new Date(today);
        monday.setDate(today.getDate() + daysToMonday);
        datePicker.value = monday.toISOString().split('T')[0];
      }

      function addEventListeners() {
        fetchButton.addEventListener('click', fetchWeekData);
        saveButton.addEventListener('click', saveAllAssignments);
        copyScheduleButton.addEventListener('click', generateAndCopySchedule);
        datePicker.addEventListener('change', () => {
            eventsContainer.innerHTML = '';
            saveContainer.style.display = 'none';
            copyScheduleButton.style.display = 'none';
            schedulePreviewContainer.style.display = 'none';
            infoSection.style.display = 'block';
        });
      }
      
      function onBootstrapSuccess(data) {
        employees = data.employees;
        hideLoading();
      }

      // --- DATA FETCHING ---
      function fetchWeekData() {
        const selectedDate = new Date(datePicker.value + 'T00:00:00Z'); // Use UTC to avoid timezone issues
        const dayOfWeek = selectedDate.getUTCDay();
        const daysToMonday = (dayOfWeek === 0) ? -6 : 1 - dayOfWeek;
        selectedDate.setUTCDate(selectedDate.getUTCDate() + daysToMonday);
        weekStartIso = selectedDate.toISOString().split('T')[0];

        showLoading(`Fetching events for the week of ${weekStartIso}...`);
        google.script.run
          .withSuccessHandler(onFetchWeekSuccess)
          .withFailureHandler(onFailure)
          .api_getWeek(weekStartIso);
      }

      function onFetchWeekSuccess(data) {
        hideLoading();
        infoSection.style.display = 'none';
        eventsData = data.events;
        renderEvents(data.events, data.assignments);
        if (data.events.length > 0) {
          saveContainer.style.display = 'block';
          copyScheduleButton.style.display = 'inline-block';
        } else {
          eventsContainer.innerHTML = '<div class="info-section"><p class="info-text">No events found for this week.</p></div>';
          saveContainer.style.display = 'none';
          copyScheduleButton.style.display = 'none';
        }
      }

      // --- UI RENDERING ---
      function renderEvents(events, assignments) {
        eventsContainer.innerHTML = '';
        events.forEach(event => {
          const eventAssignments = assignments[event.id] || [];
          const eventCard = createEventCard(event, eventAssignments);
          eventsContainer.appendChild(eventCard);
        });
      }

      function createEventCard(event, assignments) {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.dataset.eventId = event.id;
        card.dataset.eventDate = event.date;
        card.dataset.eventStart = event.start;
        card.dataset.eventEnd = event.end;
        card.dataset.eventTitle = event.title;
        card.dataset.fullAddress = event.fullAddress || '';

        const eventDate = new Date(event.date + 'T00:00:00Z');

        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <h2 class="event-title">${event.title}</h2>
            <span class="event-date-badge">${eventDate.toLocaleDateString('en-US', { timeZone: 'UTC', weekday: 'short', month: 'short', day: 'numeric' })}</span>
          </div>
          <p class="event-time">${formatTime(event.start)} - ${formatTime(event.end)}</p>
          
          <div class="location-section">
             <label class="location-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                <a href="https://www.google.com/maps?q=${encodeURIComponent(event.fullAddress)}" target="_blank" class="location-link">
                  <span>${event.fullAddress || 'No location specified'}</span>
                </a>
             </label>
          </div>

          <div class="time-slot-container" style="margin-top: 1rem;">
            <label class="time-slot-label">Assign Staff</label>
            <div class="staff-assignments-container">
              ${assignments.map(staff => createStaffRow(staff.name, staff.start, staff.end)).join('')}
            </div>
            <button class="btn-add-staff" style="margin-top: 0.5rem;">+ Add Staff</button>
          </div>
          
           <div class="notes-section" style="margin-top: 1rem;">
              <label for="event-notes-${event.id}" class="notes-label">Event Notes</label>
              <textarea id="event-notes-${event.id}" class="notes-textarea" rows="3" placeholder="Add any specific instructions for this event...">${event.notes || ''}</textarea>
          </div>
        `;

        card.querySelector('.btn-add-staff').addEventListener('click', () => addStaffRow(card, event));
        card.querySelectorAll('.btn-remove-staff').forEach(btn => {
            btn.addEventListener('click', (e) => e.target.closest('.staff-assignment-row').remove());
        });

        return card;
      }
      
      function addStaffRow(card, event) {
          const container = card.querySelector('.staff-assignments-container');
          const newRowHTML = createStaffRow('', event.start, event.end);
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = newRowHTML;
          const newRowElement = tempDiv.firstElementChild;
          newRowElement.querySelector('.btn-remove-staff').addEventListener('click', (e) => e.target.closest('.staff-assignment-row').remove());
          container.appendChild(newRowElement);
      }

      function createStaffRow(selectedStaff, startTime, endTime) {
          return `
            <div class="staff-assignment-row" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
              <select class="staff-dropdown" style="flex-grow: 1;">
                <option value="">Select Staff Member</option>
                ${employees.map(emp => `<option value="${emp.Name}" ${emp.Name === selectedStaff ? 'selected' : ''}>${emp.Name}</option>`).join('')}
              </select>
              <input type="time" class="time-input start-time" value="${startTime || '09:00'}">
              <input type="time" class="time-input end-time" value="${endTime || '17:00'}">
              <button class="btn-remove-staff">Remove</button>
            </div>
          `;
      }

      // --- DATA SAVING ---
      function saveAllAssignments() {
        showLoading('Saving assignments...');
        const eventCards = document.querySelectorAll('.event-card');
        let allSaves = [];

        eventCards.forEach(card => {
          const eventId = card.dataset.eventId;
          const eventData = {
            title: card.dataset.eventTitle,
            date: card.dataset.eventDate,
            start: card.dataset.eventStart,
            end: card.dataset.eventEnd,
            fullAddress: card.dataset.fullAddress,
            notes: card.querySelector('.notes-textarea').value.trim()
          };

          const assignments = [];
          card.querySelectorAll('.staff-assignment-row').forEach(row => {
            const name = row.querySelector('.staff-dropdown').value;
            const start = row.querySelector('.start-time').value;
            const end = row.querySelector('.end-time').value;
            if (name && start && end) {
              assignments.push({ name, start, end });
            }
          });
          
          const savePromise = new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .api_saveAssignment(weekStartIso, eventId, eventData, assignments);
          });
          allSaves.push(savePromise);
        });

        Promise.all(allSaves)
          .then(onSaveSuccess)
          .catch(onFailure);
      }

      function onSaveSuccess() {
        hideLoading();
        showSuccess('All assignments saved successfully!');
        fetchWeekData(); // Refresh data to show saved state
      }
      
      // --- SCHEDULE GENERATION ---
      function generateAndCopySchedule() {
        showLoading('Generating group chat message...');
        google.script.run
          .withSuccessHandler(onGenerateScheduleSuccess)
          .withFailureHandler(onFailure)
          .api_getScheduleMessage(weekStartIso);
      }

      function onGenerateScheduleSuccess(result) {
        hideLoading();
        if (result.success) {
          schedulePreview.value = result.message;
          schedulePreviewContainer.style.display = 'block';
          navigator.clipboard.writeText(result.message).then(() => {
            showSuccess('Schedule message copied to clipboard!');
          }, () => {
            showError('Could not copy to clipboard, but you can copy from the text box below.');
          });
        } else {
          onFailure({ message: result.message });
        }
      }

      // --- UTILITIES ---
      function showLoading(message) {
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-overlay').style.display = 'flex';
      }

      function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
      }
      
      function showSuccess(message) {
        alert(message); // Simple feedback for now
      }

      function showError(message) {
        alert('Error: ' + message);
      }

      function onFailure(error) {
        hideLoading();
        console.error('An error occurred:', error);
        showError(error.message || 'An unknown error occurred.');
      }
      
      function formatTime(timeStr) {
        if (!timeStr || !timeStr.includes(':')) return 'All Day';
        const [h, m] = timeStr.split(':');
        const hours = parseInt(h, 10);
        if (isNaN(hours)) return 'N/A';
        const suffix = hours >= 12 ? 'pm' : 'am';
        const civilianHours = ((hours + 11) % 12 + 1);
        return `${civilianHours}:${m}${suffix}`;
      }

      // --- START THE APP ---
      initialize();
    });
  </script>
</body>
</html>
